L.LeafletTrueStory=L.Control.extend({options:{id:null,mode:"full",padding:"10px",background:"transparent",interactThrough:!1,control:!1,controlLabel:"Toggle storymap",position:"topleft",collapsed:!1,spacer:"200px",autoshift:!0,borderRadius:"20px",blured:!1,stories:[]},defaultStoryOptions:{id:null,title:null,content:null,width:"100%",align:"center",background:"#FFF",shadow:!0,callback:null},initialize:function(t){L.Util.setOptions(this,t)},onAdd:function(t){return this._initLayout(),this._container},_initLayout:function(){switch(this._container=L.DomUtil.create("div","leaflet-bar leaflet-truestory-openner"),this._oppener=document.createElement("a"),this._oppener.setAttribute("title",this.options.controlLabel),L.DomEvent.disableClickPropagation(this._container),L.DomEvent.disableScrollPropagation(this._container),this._container.appendChild(this._oppener),!0!==this.options.control&&(this._container.style.display="none"),this._storyContainer=document.createElement("div"),this._storyContainer.style.display="none",this._map._container.appendChild(this._storyContainer),this.options.id&&this._storyContainer.setAttribute("id",this.options.id),this._storyContainer.classList.add("leaflet-truestory"),this.options.mode){case"left":this._storyContainer.classList.add("leaflet-truestory-modeleft");break;case"right":this._storyContainer.classList.add("leaflet-truestory-moderight");break;default:this._storyContainer.classList.add("leaflet-truestory-modecenter");break}this._storyContainer.style.background=this.options.background,!0!==this.options.interactThrough&&(L.DomEvent.disableClickPropagation(this._storyContainer),L.DomEvent.disableScrollPropagation(this._storyContainer)),this._storyContainer.style.boxShadow=!0===this.options.blured?`0 0 5px 5px ${this.options.background}`:null,this._storyContainer.style.padding=this.options.padding,"[object Array]"===Object.prototype.toString.call(this.options.stories)&&this.options.stories.forEach((t=>{let e=this._createStory(t);this._storyContainer.appendChild(e);let i=document.createElement("div");i.style.height=this.options.spacer,this._storyContainer.appendChild(i),t.element=e})),this._postInit()},_createStory:function(t){story={...this.defaultStoryOptions,...t};let e=document.createElement("div");switch(e.setAttribute("id",story.id),story.align){case"left":e.classList.add("leaflet-truestory-containerleft");break;case"right":e.classList.add("leaflet-truestory-containerright");break;default:e.classList.add("leaflet-truestory-containercenter");break}let i=document.createElement("div");if(e.appendChild(i),i.classList.add("leaflet-truestory-storybloc"),i.style.width=story.width,i.style.borderRadius=this.options.borderRadius,i.style.background=story.background,i.style.boxShadow=!0===story.shadow?"0 2px 4px 0 rgba(34, 36, 38, .12), 0 2px 10px 0 rgba(34, 36, 38, .15)":null,!0===this.options.interactThrough&&(L.DomEvent.disableClickPropagation(i),L.DomEvent.disableScrollPropagation(i)),story.title){let t=document.createElement("div");i.appendChild(t),story.title instanceof HTMLElement?t.appendChild(story.title):(t.innerHTML=story.title,t.classList.add("leaflet-truestory-title"))}let o=document.createElement("div");return i.appendChild(o),o.classList.add("leaflet-truestory-content"),story.content instanceof HTMLElement?o.appendChild(story.content):o.innerHTML=story.content,e},_postInit:function(){this._oppener.addEventListener("click",(()=>{"none"==this._storyContainer.style.display?this._expand():this._collapse()})),!0!==this.options.collapsed&&this._expand();var t=null;this._last_story=this.options.stories[0],this._storyContainer.addEventListener("scroll",(e=>{clearTimeout(t),t=setTimeout((()=>{for(let t=0;t<this.options.stories.length;t++)if(this._isStoryVisible(this.options.stories[t].element,e.target)){story_visible=this.options.stories[t];break}this._last_story&&this._last_story.element==story_visible.element||(this._last_story=story_visible,"function"==typeof story_visible.callback&&story_visible.callback(story_visible))}),250)}),{passive:!0}),"function"==typeof this.options.stories[0].callback&&this.options.stories[0].callback(this.options.stories[0])},_expand:function(){if(this._storyContainer.style.display=null,!0===this.options.autoshift&&("left"===this.options.mode||"right"===this.options.mode)){let t=window.innerWidth;"left"===this.options.mode?t>640?this._shiftMap("right",15):this._shiftMap("top",20):"right"===this.options.mode&&(t>640?this._shiftMap("left",15):this._shiftMap("top",20))}},_collapse:function(){if(this._storyContainer.style.display="none",!0===this.options.autoshift&&("left"===this.options.mode||"right"===this.options.mode)){let t=window.innerWidth;"left"===this.options.mode?t>640?this._unshiftMap("right",15):this._unshiftMap("top",20):"right"===this.options.mode&&(t>640?this._unshiftMap("left",15):this._unshiftMap("top",20))}},_shiftMap:function(t,e){e=e?e/100:.15;let i=0,o=0;switch(t){case"left":i=1;break;case"right":i=-1;break;case"top":o=1;break;case"bottom":o=-1;break;default:break}let s=map.getSize().x*e*i,n=map.getSize().y*e*o;map.panBy(new L.Point(s,n),{animate:!1})},_unshiftMap:function(t,e){e=e?e/100:.15;let i=0,o=0;switch(t){case"left":i=-1;break;case"right":i=1;break;case"top":o=-1;break;case"bottom":o=1;break;default:break}let s=map.getSize().x*e*i,n=map.getSize().y*e*o;map.panBy(new L.Point(s,n),{animate:!1})},_isStoryVisible:function(t,e){const i=t.getBoundingClientRect(),o=e.getBoundingClientRect();return i.top>=o.top&&i.top<o.height+o.top},onRemove:function(t){"none"!=this._storyContainer.style.display&&this._collapse(),this._container.remove(),this._storyContainer.remove()}}),L.leafletTrueStory=function(t){return new L.LeafletTrueStory(t)};
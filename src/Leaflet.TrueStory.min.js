L.LeafletTrueStory=L.Control.extend({options:{id:null,mode:"center",background:"transparent",interactThrough:!1,toggle:!1,toggleLabel:"Toggle storymap",position:"topleft",collapsed:!1,spacer:"20em",autoshift:!0,stories:[]},defaultStoryOptions:{id:null,title:null,content:null,width:"100%",align:"center",callback:null},initialize:function(t){L.Util.setOptions(this,t)},onAdd:function(t){return this._initLayout(),this._container},_initLayout:function(){switch(this._container=L.DomUtil.create("div","leaflet-truestory-openner leaflet-bar "),this._toggle=L.DomUtil.create("a","toggle toggleimg"),this._toggle.setAttribute("title",this.options.toggleLabel),L.DomEvent.disableClickPropagation(this._container),L.DomEvent.disableScrollPropagation(this._container),this._container.appendChild(this._toggle),!0!==this.options.toggle&&(this._container.style.display="none"),this._storyContainer=document.createElement("div"),this._storyContainer.style.display="none",this._map._container.appendChild(this._storyContainer),this.options.id&&this._storyContainer.setAttribute("id",this.options.id),this._storyContainer.classList.add("leaflet-truestory"),this.options.mode){case"left":this._storyContainer.classList.add("leaflet-truestory-modeleft");break;case"right":this._storyContainer.classList.add("leaflet-truestory-moderight");break;default:this._storyContainer.classList.add("leaflet-truestory-modecenter");break}this._storyContainer.style.background=this.options.background,!0!==this.options.interactThrough&&(L.DomEvent.disableClickPropagation(this._storyContainer),L.DomEvent.disableScrollPropagation(this._storyContainer)),"[object Array]"===Object.prototype.toString.call(this.options.stories)&&this.options.stories.forEach((t=>{let e=this._createStory(t);this._storyContainer.appendChild(e);let i=document.createElement("div");i.style.height=this.options.spacer,this._storyContainer.appendChild(i),t.element=e})),this._postInit()},_createStory:function(t){story={...this.defaultStoryOptions,...t};let e=document.createElement("div");switch(e.setAttribute("id",story.id),story.align){case"left":e.classList.add("truestory-container-left");break;case"right":e.classList.add("truestory-container-right");break;default:e.classList.add("truestory-container-center");break}let i=document.createElement("div");if(e.appendChild(i),i.classList.add("leaflet-truestory-story"),i.style.width=story.width,story.title){let t=document.createElement("div");i.appendChild(t),t.classList.add("leaflet-truestory-title"),story.title instanceof HTMLElement?t.appendChild(story.title):t.innerHTML=story.title}let s=document.createElement("div");return i.appendChild(s),s.classList.add("leaflet-truestory-content"),story.content instanceof HTMLElement?s.appendChild(story.content):s.innerHTML=story.content,e},_postInit:function(){this._toggle.addEventListener("click",(()=>{"none"==this._storyContainer.style.display?this._expand():this._collapse()})),!0!==this.options.collapsed&&this._expand();var t=null;this._last_story=this.options.stories[0],this._storyContainer.addEventListener("scroll",(e=>{clearTimeout(t),t=setTimeout((()=>{for(let t=0;t<this.options.stories.length;t++)if(this._isStoryVisible(this.options.stories[t].element,e.target)){story_visible=this.options.stories[t];break}this._last_story&&this._last_story.element==story_visible.element||(this._last_story=story_visible,"function"==typeof story_visible.callback&&story_visible.callback(story_visible))}),250)}),{passive:!0}),"function"==typeof this.options.stories[0].callback&&this.options.stories[0].callback(this.options.stories[0])},_expand:function(){if(this._storyContainer.style.display=null,!0===this.options.autoshift&&("left"==this.options.mode||"right"==this.options.mode)){let t=window.innerWidth;"left"==this.options.mode?t>640?this._shiftMap("right",15):this._shiftMap("top",20):"right"==this.options.mode&&(t>640?this._shiftMap("left",15):this._shiftMap("top",20))}},_collapse:function(){if(this._storyContainer.style.display="none",!0===this.options.autoshift&&("left"==this.options.mode||"right"==this.options.mode)){let t=window.innerWidth;"left"==this.options.mode?t>640?this._unshiftMap("right",15):this._unshiftMap("top",20):"right"==this.options.mode&&(t>640?this._unshiftMap("left",15):this._unshiftMap("top",20))}},_shiftMap:function(t,e){e=e?e/100:.15;let i=0,s=0;switch(t){case"left":i=1;break;case"right":i=-1;break;case"top":s=1;break;case"bottom":s=-1;break;default:break}let o=map.getSize().x*e*i,n=map.getSize().y*e*s;map.panBy(new L.Point(o,n),{animate:!1})},_unshiftMap:function(t,e){e=e?e/100:.15;let i=0,s=0;switch(t){case"left":i=-1;break;case"right":i=1;break;case"top":s=-1;break;case"bottom":s=1;break;default:break}let o=map.getSize().x*e*i,n=map.getSize().y*e*s;map.panBy(new L.Point(o,n),{animate:!1})},_isStoryVisible:function(t,e){const i=t.getBoundingClientRect(),s=e.getBoundingClientRect();return i.top>=s.top&&i.top<s.height+s.top},onRemove:function(t){this._container.remove(),this._storyContainer.remove()}}),L.leafletTrueStory=function(t){return new L.LeafletTrueStory(t)};